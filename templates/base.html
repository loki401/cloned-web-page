<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flipkart Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/title.png' %}">
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <div class="text-white-50 mb-2"><img src="{% static 'images/plus.png' %}" alt="Plus" style="height:48px;width:118px;vertical-align:middle;"></div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <form class="d-flex ms-3 flex-fill" style="max-width: 400px;" action="{% url 'products:search_results' %}" method="GET">
                    <input class="form-control me-2" type="search" name="q" placeholder="Search for products, brands and more" aria-label="Search">
                    <button class="btn btn-warning" type="submit"><i class="bi bi-search"></i></button>
                </form>
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Home</a></li>
                    <!-- <li class="nav-item"><a class="nav-link" href="{% url 'customer_care' %}">Customer Care</a></li> -->
                    <li class="nav-item"><a class="nav-link" href="{% url 'products:product_list' %}">Products</a></li>
                    
                    {% if user.is_authenticated %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'cart:cart' %}"><i class="bi bi-cart3"></i> Cart</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'orders:orders' %}">Orders</a></li>
                        
                        <!-- Wishlist -->
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'users:my_wishlist' %}">
                                <i class="bi bi-heart"></i>
                            </a>
                        </li>
                        
                        <!-- Notifications Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-bell"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-badge" style="display: none;">
                                    <span id="notification-count">0</span>
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                                <li><h6 class="dropdown-header d-flex justify-content-between align-items-center">
                                    Notifications
                                    <button class="btn btn-sm btn-outline-primary" id="mark-all-read-btn" style="font-size: 0.75rem;">Mark All Read</button>
                                </h6></li>
                                <li><hr class="dropdown-divider"></li>
                                <div id="notifications-list">
                                    <li><span class="dropdown-item-text text-muted">Loading notifications...</span></li>
                                </div>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-center" href="{% url 'users:notifications' %}">View All Notifications</a></li>
                            </ul>
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i> {{ user.username|title }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li><h6 class="dropdown-header">Hello, {{ user.username|title }}!</h6></li>
                                <li><a class="dropdown-item" href="{% url 'users:profile' %}"><i class="bi bi-person"></i> My Profile</a></li>
                                <li><a class="dropdown-item" href="{% url 'orders:orders' %}"><i class="bi bi-box-seam"></i> My Orders</a></li>
                                <li><a class="dropdown-item" href="{% url 'cart:cart' %}"><i class="bi bi-cart3"></i> My Cart</a></li>
                                {% if user.is_superuser %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'custom_admin:dashboard' %}"><i class="bi bi-gear"></i> Admin Panel</a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'users:logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'users:login' %}"><i class="bi bi-box-arrow-in-right"></i> Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'users:register' %}"><i class="bi bi-person-plus"></i> Sign Up</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-bell-fill text-primary me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        {% block content %}
        {% endblock %}
    </main>
    <!-- Footer -->
    <footer class="bg-dark text-white mt-5">
        <div class="container py-5">
            <div class="row">
                <!-- ABOUT Section -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                    <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">ABOUT</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'customer_care' %}" class="text-white-50 text-decoration-none small mb-2 d-block">Contact Us</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">About Us</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Careers</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Flipkart Stories</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Press</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Corporate Information</a></li>
                    </ul>
                </div>

                <!-- GROUP COMPANIES Section -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                    <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">GROUP COMPANIES</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Myntra</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Cleartrip</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Shopsy</a></li>
                    </ul>
                </div>

                <!-- HELP Section -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                    <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">HELP</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Payments</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Shipping</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Cancellation & Returns</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">FAQ</a></li>
                    </ul>
                </div>

                <!-- CONSUMER POLICY Section -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                    <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">CONSUMER POLICY</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Cancellation & Returns</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Terms Of Use</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Security</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Privacy</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Sitemap</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">Grievance Redressal</a></li>
                        <li><a href="#" class="text-white-50 text-decoration-none small mb-2 d-block">EPR Compliance</a></li>
                    </ul>
                </div>

                <!-- MAIL US Section -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                    <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">MAIL US</h6>
                    <div class="text-white-50 small">
                        <p class="mb-2">Flipkart Internet Private Limited,</p>
                        <p class="mb-2">Buildings Alyssa, Begonia &</p>
                        <p class="mb-2">Clove Embassy Tech Village,</p>
                        <p class="mb-2">Outer Ring Road, Devarabeesanahalli Village,</p>
                        <p class="mb-2">Bengaluru, 560103,</p>
                        <p class="mb-2">Karnataka, India</p>
                    </div>
                    
                    <!-- Social Media Links -->
                    <div class="mt-3">
                        <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">SOCIAL</h6>
                        <div class="d-flex gap-2">
                            <a href="#" class="text-white-50"><i class="bi bi-facebook" style="font-size: 20px;"></i></a>
                            <a href="#" class="text-white-50"><i class="bi bi-twitter" style="font-size: 20px;"></i></a>
                            <a href="#" class="text-white-50"><i class="bi bi-youtube" style="font-size: 20px;"></i></a>
                            <a href="#" class="text-white-50"><i class="bi bi-instagram" style="font-size: 20px;"></i></a>
                        </div>
                    </div>
                </div>

                <!-- REGISTERED OFFICE ADDRESS Section -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
                    <h6 class="text-uppercase mb-3" style="color: #878787; font-size: 12px; font-weight: 500;">REGISTERED OFFICE ADDRESS</h6>
                    <div class="text-white-50 small">
                        <p class="mb-2">Flipkart Internet Private Limited,</p>
                        <p class="mb-2">Buildings Alyssa, Begonia &</p>
                        <p class="mb-2">Clove Embassy Tech Village,</p>
                        <p class="mb-2">Outer Ring Road, Devarabeesanahalli Village,</p>
                        <p class="mb-2">Bengaluru, 560103,</p>
                        <p class="mb-2">Karnataka, India</p>
                        <p class="mb-2"><strong>CIN:</strong> U51109KA2012PTC066107</p>
                        <p class="mb-2"><strong>Telephone:</strong> <a href="tel:044-45614700" class="text-primary text-decoration-none">044-45614700</a> / <a href="tel:044-67415800" class="text-primary text-decoration-none">044-67415800</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="border-top" style="border-color: #404040 !important;">
            <div class="container py-4">
                <div class="row align-items-center">
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop text-warning me-2" style="font-size: 16px;"></i>
                            <a href="{% url 'become_seller' %}" class="text-white-50 small text-decoration-none">Become a Seller</a>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-megaphone text-warning me-2" style="font-size: 16px;"></i>
                            <a href="{% url 'advertise' %}" class="text-white-50 small text-decoration-none">Advertise</a>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-gift text-warning me-2" style="font-size: 16px;"></i>
                            <a href="{% url 'gift_cards' %}" class="text-white-50 small text-decoration-none">Gift Cards</a>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-question-circle text-warning me-2" style="font-size: 16px;"></i>
                            <a href="{% url 'help_center' %}" class="text-white-50 small text-decoration-none">Help Center</a>
                        </div>
                    </div>
                </div>
                
                <!-- Copyright and Payment Methods -->
                <div class="row mt-4 pt-3 border-top" style="border-color: #404040 !important;">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <span class="text-white-50 small">Â© 2007-{% now "Y" %} Flipkart.com</span>
                    </div>
                    <!-- <div class="col-md-6 text-md-end">
                        <div class="d-flex justify-content-md-end justify-content-start align-items-center gap-2 flex-wrap">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/visa_v2.png" alt="Visa" style="height: 20px;">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/mc_v2.png" alt="Mastercard" style="height: 20px;">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/ae_v2.png" alt="American Express" style="height: 20px;">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/dc_v2.png" alt="Diners Club" style="height: 20px;">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/nb_v2.png" alt="Net Banking" style="height: 20px;">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/emi_v2.png" alt="EMI" style="height: 20px;">
                            <img src="https://static-assets-web.flixcart.com/fk-p-linchpin-web/fk-cp-zion/img/payment-method/cod_v2.png" alt="Cash on Delivery" style="height: 20px;">
                        </div>
                    </div> -->
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if user.is_authenticated %}
    <script>
        // Notification functionality
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBadge = document.getElementById('notification-badge');
            const notificationCount = document.getElementById('notification-count');
            const notificationsList = document.getElementById('notifications-list');
            const markAllReadBtn = document.getElementById('mark-all-read-btn');
            
            // Function to get CSRF token
            function getCSRFToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            }
            
            // Function to update notification count
            function updateNotificationCount() {
                fetch('{% url "users:notifications_count" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.unread_count > 0) {
                            notificationBadge.style.display = 'block';
                            notificationCount.textContent = data.unread_count;
                        } else {
                            notificationBadge.style.display = 'none';
                        }
                    })
                    .catch(error => console.error('Error fetching notification count:', error));
            }
            
            // Function to load notifications
            function loadNotifications() {
                fetch('{% url "users:notifications" %}')
                    .then(response => response.text())
                    .then(html => {
                        // Extract notifications from the response
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const notifications = doc.querySelectorAll('.notification-item');
                        
                        if (notifications.length === 0) {
                            notificationsList.innerHTML = '<li><span class="dropdown-item-text text-muted">No notifications</span></li>';
                        } else {
                            let notificationsHTML = '';
                            notifications.forEach((notification, index) => {
                                if (index < 5) { // Show only first 5 in dropdown
                                    const title = notification.querySelector('.notification-title')?.textContent || '';
                                    const message = notification.querySelector('.notification-message')?.textContent || '';
                                    const time = notification.querySelector('.notification-time')?.textContent || '';
                                    const isRead = notification.classList.contains('read');
                                    const notificationId = notification.dataset.notificationId;
                                    
                                    notificationsHTML += `
                                        <li>
                                            <div class="dropdown-item notification-dropdown-item ${isRead ? '' : 'bg-light'}" data-notification-id="${notificationId}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1 small">${title}</h6>
                                                        <p class="mb-1 small text-muted">${message.substring(0, 80)}${message.length > 80 ? '...' : ''}</p>
                                                        <small class="text-muted">${time}</small>
                                                    </div>
                                                    ${!isRead ? '<span class="badge bg-primary ms-2">New</span>' : ''}
                                                </div>
                                            </div>
                                        </li>
                                    `;
                                }
                            });
                            notificationsList.innerHTML = notificationsHTML;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading notifications:', error);
                        notificationsList.innerHTML = '<li><span class="dropdown-item-text text-danger">Error loading notifications</span></li>';
                    });
            }
            
            // Mark all notifications as read
            markAllReadBtn.addEventListener('click', function() {
                fetch('{% url "users:mark_all_notifications_read" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationCount();
                        loadNotifications();
                    }
                })
                .catch(error => console.error('Error marking notifications as read:', error));
            });
            
            // Load notifications when dropdown is opened
            document.getElementById('notificationsDropdown').addEventListener('click', function() {
                loadNotifications();
            });
            
            // Initial load
            updateNotificationCount();
            
            // Update notification count every 30 seconds
            setInterval(updateNotificationCount, 30000);
            
            // Function to show toast notification
            window.showNotificationToast = function(message, type = 'info') {
                const toastBody = document.getElementById('toastBody');
                const toast = document.getElementById('notificationToast');
                
                toastBody.textContent = message;
                
                // Change toast style based on type
                const toastElement = new bootstrap.Toast(toast);
                toastElement.show();
            };
        });
    </script>
    {% endif %}
</body>
</html>